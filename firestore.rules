rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is super_admin
    function isSuperAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Helper functions for admin access (email OR role-based)
    function isLibraryAdmin() {
      return request.auth != null && (
        request.auth.token.email.lower() == 'libraryhumsj@gmail.com' ||
        (exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == 'library_admin')
      );
    }
    
    function isTutorialAdmin() {
      return request.auth != null && (
        request.auth.token.email.lower() == 'tutorialhumsj@gmail.com' ||
        (exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == 'tutorial_admin')
      );
    }
    
    function isTrainingAdmin() {
      return request.auth != null && (
        request.auth.token.email.lower() == 'traininghumsj@gmail.com' ||
        (exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == 'training_admin')
      );
    }
    
    function isAnyAdmin() {
      return isSuperAdmin() || isLibraryAdmin() || isTutorialAdmin() || isTrainingAdmin();
    }
    
    // User roles collection - READ for authenticated users, WRITE for admins
    // Allow admin emails to create/update their own role on first login
    match /user_roles/{userId} {
      allow read: if request.auth != null;
      // Allow create/update for own document if user is an admin email
      allow create, update: if request.auth != null && request.auth.uid == userId && (
        request.auth.token.email.lower() == 'libraryhumsj@gmail.com' ||
        request.auth.token.email.lower() == 'tutorialhumsj@gmail.com' ||
        request.auth.token.email.lower() == 'traininghumsj@gmail.com'
      );
      // Super admin can create/update any user's role
      allow create, update: if isSuperAdmin();
      allow delete: if false; // Prevent role deletion
    }
    
    // Users collection - super_admin can read all users for management
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSuperAdmin());
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (
        request.auth.uid == userId || 
        isSuperAdmin()
      );
    }
    
    // Helper function to check if user has specific role
    function hasRole(role) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == role;
    }
    
    // Training programs collection
    match /trainings/{trainingId} {
      allow read: if true; // Public read so landing page can show upcoming trainings
      allow create, update, delete: if isTrainingAdmin() || isSuperAdmin(); // Only training admin or super_admin

      // Training registrations subcollection
      match /registrations/{registrationId} {
        allow create: if request.auth != null; // Any authenticated user can register
        allow read: if request.auth != null && (isSuperAdmin() || isTrainingAdmin() || hasRole('trainer'));
        allow update, delete: if isTrainingAdmin() || isSuperAdmin();
      }
    }
    
    // Tutorial sessions collection
    match /tutorial_sessions/{sessionId} {
      allow read: if true; // Public read so landing page can show active tutorials
      allow create, update, delete: if isTutorialAdmin() || isSuperAdmin(); // Only tutorial admin or super_admin
    }

    // Tutorial registrations subcollection
    match /tutorial_sessions/{sessionId}/registrations/{registrationId} {
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      allow read: if request.auth != null
                  && (resource.data.userId == request.auth.uid || isSuperAdmin() || isTutorialAdmin() || hasRole('tutor'));
      allow update, delete: if isTutorialAdmin() || isSuperAdmin();
    }
    
    // Library resources collection
    match /library_resources/{resourceId} {
      allow read: if true; // Public read so landing page can show latest library uploads
      allow create, update, delete: if isLibraryAdmin() || isSuperAdmin(); // Only library admin or super_admin
    }

    // Borrow requests collection
    match /borrow_requests/{requestId} {
      // Allow anyone to submit a borrow request (public form on landing page)
      allow create: if true;
      // Only admins can read all requests, users can read their own by email
      allow read: if isLibraryAdmin() || isSuperAdmin() || 
                    (request.auth != null && resource.data.email == request.auth.token.email);
      allow update, delete: if isLibraryAdmin() || isSuperAdmin();
    }

    // Notifications collection - real-time notifications for all users
    match /notifications/{notificationId} {
      // Anyone can read notifications (for real-time updates)
      allow read: if true;
      // Admins can create notifications
      allow create: if request.auth != null && isAnyAdmin();
      // Authenticated users can update to mark as read (add their uid to readBy array)
      allow update: if request.auth != null && 
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']);
      // Only super admin can delete notifications
      allow delete: if isSuperAdmin();
    }

    // Classified resources collection (landing + academic files managed via backend)
    match /classified_resources/{resourceId} {
      // Public read access so landing page can show latest classified uploads
      allow read: if true;
      // Prevent direct writes from clients; resources are created via the backend (Admin SDK)
      allow create, update, delete: if false;
    }
    
    // Default deny all other collections until specific rules are added
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
